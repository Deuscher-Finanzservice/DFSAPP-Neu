<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard</title>
  <link rel="stylesheet" href="../../styles/base.css">
  <link rel="stylesheet" href="../../styles/print.css" media="print">
  <script src="../../scripts/format.js"></script>
  <script src="../../scripts/toast.js"></script>
  <script src="../../scripts/date.js"></script>
  <script src="../../scripts/storage.js"></script>
  <style>.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}@media(max-width:900px){.grid{grid-template-columns:1fr}}</style>
  </head>
<body>
  <div class="card">
    <h2>Übersicht</h2>
    <div class="actions no-print" style="display:flex; gap:8px; justify-content:flex-end;">
      <button class="btn btn-primary" onclick="window.print()">Als PDF speichern</button>
    </div>
    <div class="grid">
      <div class="card"><div class="label">Kunden</div><div id="nCustomers" style="font-size:28px;font-weight:700">0</div><div style="margin-top:8px"><a class="btn outline" href="../customers/index.html" target="_parent">Zur Kundenliste</a></div></div>
      <div class="card"><div class="label">Verträge</div><div id="nContracts" style="font-size:28px;font-weight:700">0</div><div style="margin-top:8px"><a class="btn outline" href="../contracts/index.html" target="_parent">Zu Verträgen</a></div></div>
      <div class="card"><div class="label">Analyse</div><div>Jahressumme: <strong id="sumAnnual">–</strong></div><div>Monatliche Ersparnis (Soll): <strong id="saving">–</strong></div><div>Risiko-Score: <strong id="risk">–</strong></div><div style="margin-top:8px"><a class="btn outline" href="../analysis/index.html" target="_parent">Zur Analyse</a></div></div>
      <div class="card">
        <div class="label">Jahressumme</div>
        <strong id="kpi-sum-annual">0,00 €</strong>
        <div class="label" style="margin-top:8px">Monatliche Ersparnis (Ziel)</div>
        <strong id="kpi-monthly-saving">0,00 €</strong>
      </div>
    </div>
  </div>
  <section id="upcoming-reminders" class="card" style="margin-top:16px;">
    <h3>Demnächst fällig (≤ 90 Tage)</h3>
    <div id="upcoming-list" class="stack"></div>
  </section>
  <section id="analysis-results" class="card" style="margin-top:16px;">
    <h3>Analyse-Ergebnisse</h3>
    <div id="analysis-kpis-dash" class="grid" style="margin-top:8px;"></div>
    <h4>Warnungen</h4>
    <div id="analysis-warnings-dash" class="stack"></div>
    <h4>Empfehlungen</h4>
    <div id="analysis-recos-dash" class="stack"></div>
  </section>
  <div id="reminders" style="display:none"></div>
  <script>
    const fmt=(n)=> (Number(n)||0).toLocaleString('de-DE',{style:'currency',currency:'EUR'});
    function renderDashboard(){
      const customers = JSON.parse(localStorage.getItem('dfs.customers')||'[]');
      const contracts = JSON.parse(localStorage.getItem('dfs.contracts')||'[]');
      const a = JSON.parse(localStorage.getItem('dfs.analysis')||'{}');
      document.getElementById('nCustomers').textContent = Array.isArray(customers)?customers.length:0;
      document.getElementById('nContracts').textContent = Array.isArray(contracts)?contracts.length:0;
      document.getElementById('sumAnnual').textContent = fmt(a.sumAnnual||0);
      document.getElementById('saving').textContent = fmt(a.monthlySaving||0);
      document.getElementById('risk').textContent = a.riskScore??'–';
      try{
        const now = new Date();
        const in90 = new Date(now.getTime()); in90.setDate(in90.getDate()+90);
        const list = (Array.isArray(contracts)?contracts:[]).map(c=>{
          let d = c.reminderDate || '';
          if(!d && (c.beginISO||c.beginn)){ // fallback compute if missing
            const b = new Date((c.beginISO||c.beginn)+'T00:00:00'); const t=new Date(b.getTime()); t.setFullYear(t.getFullYear()+3); t.setMonth(t.getMonth()-3);
            d = `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
          }
          return {insurer:(c.versicherer||c.insurer), policyNo:(c.policeNr||c.policyNo||c.policyNumber||''), reminderDate:d};
        }).filter(x=>x.reminderDate).map(x=>({
          ...x, date:new Date(x.reminderDate+'T00:00:00')
        })).filter(x=> x.date>=now && x.date<=in90 ).sort((a,b)=> a.date-b.date);
        document.getElementById('reminders').innerHTML = list.length? list.map(x=>{
          const d=`${x.date.getDate().toString().padStart(2,'0')}.${(x.date.getMonth()+1).toString().padStart(2,'0')}.${x.date.getFullYear()}`;
          return `<div class="badge">${d}: ${x.insurer||'–'} ${x.policyNo?('('+x.policyNo+')'):''}</div>`;
        }).join('') : '<span style="color:var(--muted)">Keine</span>';
      }catch(e){ document.getElementById('reminders').textContent = '—'; }
    }
    renderDashboard();
    window.addEventListener('dfs.contracts-changed', renderDashboard);
    window.addEventListener('dfs.analysis-changed', renderDashboard);
    window.addEventListener('storage', (e)=>{
      if(['dfs.contracts','dfs.analysis','dfs.customers'].includes(e.key)) renderDashboard();
    });
  </script>
  <script src="./index.js"></script>
</body>
</html>
