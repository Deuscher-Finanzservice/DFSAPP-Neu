<!doctype html><html lang="de"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../../styles/main.css">
<title>Verträge</title></head><body>
<div class="card">
  <h2>Verträge & Sparten</h2>
  <div class="row">
    <div class="col"><label>Versicherer</label>
      <input list="versichererList" id="versicherer" placeholder="z. B. Allianz">
      <datalist id="versichererList">
        <option value="Allianz">
        <option value="R+V Versicherung">
        <option value="Generali Deutschland">
        <option value="Debeka">
        <option value="AXA">
        <option value="Signal Iduna">
        <option value="HUK-Coburg">
        <option value="ERGO">
        <option value="Zurich Gruppe Deutschland">
        <option value="LVM">
        <option value="Talanx (HDI)">
        <option value="Provinzial">
        <option value="Württembergische">
        <option value="Gothaer">
        <option value="Continentale">
        <option value="DEVK">
        <option value="Barmenia">
        <option value="Basler (Baloise)">
        <option value="Die Bayerische">
        <option value="SV Sparkassenversicherung">
        <option value="Nürnberger">
        <option value="Alte Leipziger">
        <option value="Volkswohl Bund">
        <option value="Concordia">
        <option value="Inter Versicherung">
        <option value="Öffentliche Versicherung Braunschweig">
        <option value="VGH Versicherungen">
        <option value="ÖRAG Rechtsschutz">
        <option value="HanseMerkur">
        <option value="CosmosDirekt">
      </datalist>
    </div>
    <div class="col"><label>Produkt (optional)</label><input id="produkt" placeholder="optional"></div>
    <div class="col"><label>Police-Nr.</label><input id="police"></div>
    <div class="col"><label>Beginn (YYYY-MM-DD)</label><input id="beginn" type="date"></div>
    <div class="col"><label>Ende (optional)</label><input id="ende" type="date"></div>
    <div class="col"><label>Zahlweise</label>
      <select id="zahlweise">
        <option value="jährlich">jährlich</option>
        <option value="halbjährlich">halbjährlich</option>
        <option value="vierteljährlich">vierteljährlich</option>
        <option value="monatlich">monatlich</option>
      </select>
    </div>
    <div class="col"><label>Jahresbeitrag (Brutto)</label><input id="beitrag" type="text" placeholder="1.234,56"></div>
    <div class="col"><label>Deckungssumme (optional)</label><input id="deckung" type="text" placeholder="5.000.000"></div>
    <div class="col"><label>Selbstbehalt (optional)</label><input id="sb" type="text" placeholder="500"></div>
    <div class="col"><label>Kündigungsfrist (optional)</label><input id="kf" placeholder="optional"></div>
    <div class="col"><label>Hauptfälligkeit (optional)</label><input id="hf" placeholder="optional"></div>
  </div>

  <div class="card" style="margin-top:10px">
    <strong>Sparten</strong>
    <div class="row">
      <div class="col">
        <select id="sparten" multiple size="6">
          <option>Betriebshaftpflicht (BHV)</option>
          <option>Inhalt</option>
          <option>Gebäude</option>
          <option>Ertragsausfall/BU</option>
          <option>Cyber</option>
          <option>Rechtsschutz</option>
          <option>D&O</option>
          <option>Gruppenunfall</option>
        </select>
      </div>
      <div class="col">
        <label>Versicherte Gefahren (mehrfach auswählbar)</label>
        <select id="gefahren" multiple size="8"></select>
      </div>
      <div class="col">
        <label>Empfehlungen (altes System je Sparte)</label>
        <div id="empf" class="chips"></div>
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <button class="btn" id="add">+ Vertrag hinzufügen</button>
    <button class="btn-outline" id="clear">Felder leeren</button>
  </div>
</div>

<div class="card" style="margin-top:12px">
  <strong>Bestand</strong>
  <table class="table" id="tbl">
    <thead><tr>
      <th>Versicherer</th><th>Police</th><th>Sparten</th><th>Beitrag/Jahr</th><th>Deckung</th><th>Gefahren</th><th></th>
    </tr></thead>
    <tbody></tbody>
  </table>
  <div style="margin-top:8px;color:var(--muted)">Summe: <span id="sum"></span></div>
</div>

<script src='../../scripts/storage.js?v=old-per-sparte-001'></script>
<script>
  const selSparten = document.getElementById('sparten');
  const selGefahren = document.getElementById('gefahren');
  const empfWrap = document.getElementById('empf');

  function refreshGefahren(){
    const selected = Array.from(selSparten.selectedOptions).map(o=>o.value);
    const set = new Set();
    if(selected.length===0){
      DFS.STD.defaultGefahren.forEach(g=>set.add(g));
    }else{
      selected.forEach(s=>{
        (DFS.STD.gefahrenBySparte[s] || DFS.STD.defaultGefahren).forEach(g=>set.add(g));
      });
    }
    selGefahren.innerHTML='';
    Array.from(set).forEach(g=>{
      const opt = document.createElement('option'); opt.textContent=g; selGefahren.appendChild(opt);
    });
  }
  selSparten.addEventListener('change', function(){
    refreshGefahren();
    renderEmpf();
  });
  refreshGefahren();

  function renderEmpf(){
    const selectedSparten = Array.from(selSparten.selectedOptions).map(o=>o.value);
    const items = DFS.getAlteEmpfehlungen(selectedSparten);
    empfWrap.innerHTML='';
    items.forEach((e,i)=>{
      const chip = document.createElement('div'); chip.className='chip'; chip.textContent=e; chip.dataset.idx=i;
      chip.onclick = ()=> chip.classList.toggle('warn');
      empfWrap.appendChild(chip);
    });
  }
  renderEmpf();

  function field(id){ return document.getElementById(id).value; }
  function clearFields(){ ["versicherer","produkt","police","beginn","ende","beitrag","deckung","sb","kf","hf"].forEach(id=>document.getElementById(id).value=''); selSparten.selectedIndex=-1; refreshGefahren(); renderEmpf(); }

  function add(){
    const cts = DFS.getContracts();
    const now = new Date().toISOString();
    const recs = Array.from(empfWrap.children).filter(ch=>ch.classList.contains('warn')).map(ch=>ch.textContent);
    const obj = {
      id: 'v_'+Math.random().toString(36).slice(2),
      sparten: Array.from(selSparten.selectedOptions).map(o=>o.value),
      versicherer: field('versicherer'),
      produkt: field('produkt') || null,
      policeNr: field('police'),
      beginn: field('beginn'),
      ende: field('ende') || null,
      hauptfaellig: field('hf') || null,
      zahlweise: document.getElementById('zahlweise').value,
      jahresbeitragBrutto: DFS.parseNum(field('beitrag')),
      deckungssumme: DFS.parseNum(field('deckung')) || null,
      selbstbehalt: DFS.parseNum(field('sb')) || null,
      kuendigungsfrist: field('kf') || null,
      gefahren: Array.from(selGefahren.selectedOptions).map(o=>o.value),
      empfehlungen: recs,
      createdAt: now, updatedAt: now
    };
    cts.push(obj);
    DFS.setContracts(cts);
    DFS.toast('Vertrag hinzugefügt.');
    clearFields();
    table();
  }

  function del(id){
    const cts = DFS.getContracts().filter(x=>x.id!==id);
    DFS.setContracts(cts);
    table();
  }

  function table(){
    const tbody = document.querySelector('#tbl tbody');
    tbody.innerHTML='';
    const cts = DFS.getContracts();
    cts.forEach(c=>{
      const tr = document.createElement('tr');
      tr.innerHTML = '<td>'+ (c.versicherer||'') +'</td>'+
      '<td>'+ (c.policeNr||'') +'</td>'+
      '<td>'+ (c.sparten||[]).join(', ') +'</td>'+
      '<td>'+ DFS.currencyDE(c.jahresbeitragBrutto||0) +'</td>'+
      '<td>'+ (c.deckungssumme? DFS.currencyDE(c.deckungssumme):'–') +'</td>'+
      '<td>'+ (c.gefahren||[]).join(', ') +'</td>'+
      '<td><button class="btn-danger" data-id="'+c.id+'">Löschen</button></td>';
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('button.btn-danger').forEach(b=> b.onclick=()=>del(b.dataset.id));
    const sum = cts.reduce((a,c)=>a+(c.jahresbeitragBrutto||0),0);
    document.getElementById('sum').textContent = DFS.currencyDE(sum);
  }

  document.getElementById('add').onclick = add;
  document.getElementById('clear').onclick = clearFields;
  table();
</script>
</body></html>
