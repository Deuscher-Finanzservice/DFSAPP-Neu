<!doctype html>
<html lang="de"><head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kundenliste</title>
  <link rel="stylesheet" href="../../styles/base.css">
  <link rel="stylesheet" href="../../styles/print.css" media="print">
  <script src="../../scripts/format.js"></script>
  <script src="../../scripts/toast.js"></script>
  <script src="../../scripts/date.js"></script>
  <script src="../../scripts/storage.js"></script>
  <script src="../../scripts/ui.js"></script>
  <script src="../../scripts/io.js"></script>
</head>
<body>
  <div class="card">
    <h2>Kunden</h2>
    <div class="actions no-print" style="display:flex; gap:8px; margin-bottom:12px;">
      <button class="btn" onclick="dfsIO.exportJson('dfs.customers','dfs_customers.json')">Export Kunden</button>
      <label class="btn-secondary">
        Import Kunden
        <input type="file" accept="application/json" style="display:none" onchange="dfsIO.importJson('dfs.customers', this.files[0])">
      </label>
    </div>
    <div class="table-search">
      <input id="customer-search" type="text" placeholder="Suche Kunde/Firma…">
      <a class="btn" href="../customer/index.html">Neu</a>
      <button class="btn outline" id="btn-save-cloud">In Cloud speichern</button>
      <button class="btn outline" id="btn-load-cloud">Aus Cloud laden</button>
    </div>
    <div class="card">
      <table id="customers-table" class="table">
        <thead>
          <tr>
            <th class="sortable" data-key="firma">Firma</th>
            <th class="sortable" data-key="ansprech">Ansprechpartner</th>
            <th class="sortable" data-key="telefon">Telefon</th>
            <th>Aktion</th>
          </tr>
        </thead>
        <tbody id="customers-body"></tbody>
      </table>
    </div>
  </div>
  <script type="module">
    import { loadCustomersFromCloud, saveCustomersToCloud } from '../../scripts/firebase.js';
    (function(){
      let allCustomers = [];
      function renderCustomers(list){
        const body = document.getElementById('customers-body'); if(!body) return;
        if(!list || list.length===0){ body.innerHTML = '<tr><td colspan="4" class="text-secondary">Keine Kunden gefunden.</td></tr>'; return; }
        body.innerHTML = list.map(c=>`
          <tr>
            <td onclick="location.href='../customer/index.html?id=${encodeURIComponent(c.id)}'">${c.firma||'—'}</td>
            <td onclick="location.href='../customer/index.html?id=${encodeURIComponent(c.id)}'">${c.ansprech||'—'}</td>
            <td onclick="location.href='../customer/index.html?id=${encodeURIComponent(c.id)}'">${c.telefon||'—'}</td>
            <td><button class="btn-ghost" onclick="deleteCustomer('${c.id}')">Löschen</button></td>
          </tr>`).join('');
      }
      function applySearch(){
        const q = (document.getElementById('customer-search')?.value||'').toLowerCase();
        const filtered = allCustomers.filter(c=> (c.firma||'').toLowerCase().includes(q) || (c.ansprech||'').toLowerCase().includes(q) );
        renderCustomers(filtered);
      }
      function applySort(key, dir){
        allCustomers.sort((a,b)=>{ const va=(a[key]||'').toString().toLowerCase(); const vb=(b[key]||'').toString().toLowerCase(); if(va<vb) return dir==='asc'?-1:1; if(va>vb) return dir==='asc'?1:-1; return 0; });
        applySearch();
      }
      async function loadAndRender(){
        try{ allCustomers = await (window.dfsData && dfsData.getAllCustomers ? dfsData.getAllCustomers() : Promise.resolve([])); }
        catch{ allCustomers = []; }
        applySearch();
      }
      document.addEventListener('DOMContentLoaded', ()=>{
        document.getElementById('customer-search')?.addEventListener('input', applySearch);
        document.querySelectorAll('th.sortable').forEach(th=>{
          th.addEventListener('click', ()=>{
            const key = th.dataset.key; const current = th.classList.contains('asc')?'asc': th.classList.contains('desc')?'desc':'';
            document.querySelectorAll('th.sortable').forEach(x=>x.classList.remove('asc','desc'));
            const next = current==='asc'?'desc':'asc'; th.classList.add(next); applySort(key,next);
          });
        });
        document.getElementById('btn-save-cloud').onclick = async ()=>{ try{ await saveCustomersToCloud(); dfsToast('In Cloud gespeichert','success'); }catch(e){ console.error(e); dfsToast('Cloud-Fehler beim Speichern','error'); } };
        document.getElementById('btn-load-cloud').onclick = async ()=>{ try{ await dfsData.getAllCustomers(); await loadAndRender(); dfsToast('Aus Cloud geladen','success'); }catch(e){ console.error(e); dfsToast('Cloud-Fehler beim Laden','error'); } };
        loadAndRender();
      });
      window.deleteCustomer = async function(id){
        dfsUI.show({
          title:'Kunden löschen',
          text:'Der Kunde und seine Dokumente werden entfernt. Optional können verknüpfte Verträge ebenfalls gelöscht werden.',
          checkText:'Ja, ich will diesen Kunden endgültig löschen.',
          onOk: async ()=>{
            try{
              const filesMap = dfsStore.get('dfs.customerFiles', {});
              const files = filesMap[id] || [];
              for(const f of files){ try{ await dfsFiles.removeByPath(f.id); }catch(_){} }
              delete filesMap[id]; dfsStore.set('dfs.customerFiles', filesMap);
              let all = dfsStore.get('dfs.customers', []); all = all.filter(c=>c.id!==id); dfsStore.set('dfs.customers', all);
              try{ await dfsCloud.delete('dfs.customers', id); }catch{}
              if(confirm('Auch verknüpfte Verträge dieses Kunden löschen?')){
                let contracts = await (window.dfsData&&dfsData.getAllContracts? dfsData.getAllContracts():Promise.resolve(dfsStore.get('dfs.contracts',[])));
                const toDelete = contracts.filter(v=> String(v.customerId||'')===String(id)).map(v=>v.id);
                const cfilesMap = dfsStore.get('dfs.contractFiles', {});
                for(const cid of toDelete){
                  for(const f of (cfilesMap[cid]||[])){ try{ await dfsFiles.removeByPath(f.id); }catch(_){} }
                  delete cfilesMap[cid];
                  try{ await dfsCloud.delete('dfs.contracts', cid); }catch{}
                }
                dfsStore.set('dfs.contractFiles', cfilesMap);
                contracts = contracts.filter(v=> String(v.customerId||'')!==String(id));
                dfsStore.set('dfs.contracts', contracts);
              }
              dfsToast('Kunde gelöscht','success');
              location.reload();
            }catch(e){ console.error(e); dfsToast('Löschen fehlgeschlagen','error'); }
          }
        });
      }
    })();
  </script>
</body>
</html>
