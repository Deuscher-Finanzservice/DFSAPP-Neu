<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kunde bearbeiten</title>
  <link rel="stylesheet" href="../../styles/base.css">
  <style>
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
  </style>
  <script>
    // no module needed for simple qs helper
    window._qs = new URLSearchParams(location.search);
  </script>
</head>
<body>
  <div class="card">
    <h2>Kundenstammdaten</h2>
    <div class="grid">
      <div><label class="label">Firma</label><input class="input" id="firma"></div>
      <div><label class="label">Ansprechpartner</label><input class="input" id="ansprech"></div>
      <div><label class="label">E‑Mail</label><input class="input" id="email" type="email"></div>
      <div><label class="label">Telefon</label><input class="input" id="telefon"></div>
      <div><label class="label">Branche (optional)</label><input class="input" id="branche"></div>
      <div><label class="label">Mitarbeiter (optional)</label><input class="input" id="mitarbeiter" type="number" step="1" min="0"></div>
      <div><label class="label">Umsatz in € (optional)</label><input class="input" id="umsatz" type="number" step="0.01" min="0"></div>
      <div><label class="label">Gründungsjahr (optional)</label><input class="input" id="gruendung" type="number" step="1" min="0"></div>
      <div style="grid-column:1/-1"><label class="label">Standort (optional)</label><input class="input" id="standort"></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
      <button class="btn" id="save">Speichern</button>
      <button class="btn outline" id="delete" style="display:none">Löschen</button>
      <a class="btn outline" href="../customers/index.html">Zur Liste</a>
    </div>
    <div class="card" id="customer-contracts-card" style="margin-top:16px">
      <h3>Verträge dieses Kunden</h3>
      <div style="display:flex;gap:8px;margin-bottom:8px;">
        <a id="btn-create-contract" class="btn" href="#" data-cid="">Vertrag anlegen</a>
      </div>
      <div class="table-wrapper">
        <table class="table" id="contracts-by-customer">
          <thead>
            <tr>
              <th>Versicherer</th>
              <th>Police</th>
              <th>Risiken</th>
              <th>Zahlweise</th>
              <th>Beitrag (€/J)</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody><!-- dynamic --></tbody>
          <tfoot>
            <tr>
              <td colspan="4" style="text-align:right"><strong>Summe</strong></td>
              <td id="contracts-sum" style="text-align:right">0,00 €</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
  <script type="module">
    import { saveCustomerToCloud, deleteCustomerFromCloud } from '../../scripts/firebase.js';
    const KEY='dfs.customers';
    const $=id=>document.getElementById(id);
    function getLocal(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch{ return []; } }
    function setLocal(a){ localStorage.setItem(KEY, JSON.stringify(a)); }
    function fill(c){ if(!c) return; ['firma','ansprech','email','telefon','branche','mitarbeiter','umsatz','gruendung','standort'].forEach(k=>{ const el=$(k); if(!el) return; const v=c[k]; el.value = (v===undefined||v===null)? '' : String(v); }); }
    const genId = () => (crypto && typeof crypto.randomUUID==='function') ? crypto.randomUUID() : `${Date.now()}-${Math.random().toString(36).slice(2)}`;
    let id = window._qs.get('id') || null;
    if(!id){ id = genId(); }
    let list = getLocal();
    let current = window._qs.get('id') ? list.find(x=>x.id===id) : null;
    if(current){ $('delete').style.display='inline-block'; }
    fill(current);
    function toNum(v){ const n = Number(v); return Number.isFinite(n) ? n : undefined; }
    function collect(){
      return {
        id,
        firma: $('firma').value.trim(),
        ansprech: $('ansprech').value.trim(),
        email: $('email').value.trim(),
        telefon: $('telefon').value.trim(),
        branche: $('branche').value.trim() || undefined,
        mitarbeiter: toNum($('mitarbeiter').value),
        umsatz: toNum($('umsatz').value),
        gruendung: toNum($('gruendung').value),
        standort: $('standort').value.trim() || undefined,
        updatedAt: new Date().toISOString(),
        createdAt: current?.createdAt || new Date().toISOString()
      };
    }
    document.getElementById('save').onclick = async ()=>{
      const c = collect();
      const arr = getLocal();
      const idx = arr.findIndex(x=>x.id===c.id);
      if(idx>=0) arr[idx]=c; else arr.push(c);
      setLocal(arr);
      try{ await saveCustomerToCloud(c); }catch(e){ console.warn('Cloud save failed', e); }
      if(!window._qs.get('id')){ history.replaceState({},'',`?id=${encodeURIComponent(id)}`); $('delete').style.display='inline-block'; }
      if(window.__dfsCustomersRenderContractsSummary) window.__dfsCustomersRenderContractsSummary();
      alert('Gespeichert');
    };
    document.getElementById('delete').onclick = async ()=>{
      if(!id) return;
      if(!confirm('Diesen Kunden löschen?')) return;
      const next = getLocal().filter(x=>x.id!==id);
      setLocal(next);
      try{ await deleteCustomerFromCloud(id); }catch(e){ console.warn('Cloud delete failed', e); }
      location.href = '../customers/index.html';
    };
    (function(){
      function fmtMoney(n){
        try{ return (Number(n)||0).toLocaleString('de-DE',{style:'currency',currency:'EUR',minimumFractionDigits:2}); }
        catch(e){ return (Number(n)||0).toFixed(2)+' €'; }
      }
      function getCurrentCustomerId(){
        var hid = document.getElementById('id');
        if(hid && hid.value) return hid.value;
        var p=new URLSearchParams(location.search);
        if(p.get('id')) return p.get('id');
        try{
          var name = (document.querySelector('input[id="firma"]')||{}).value||'';
          var email = (document.querySelector('input[id="email"]')||{}).value||'';
          var arr = JSON.parse(localStorage.getItem('dfs.customers')||'[]');
          var hit = arr.find(c=> (c.firma||'')===name && (c.email||'')===email );
          return hit ? hit.id : null;
        }catch(e){}
        return null;
      }
      function readContracts(){
        try{ return JSON.parse(localStorage.getItem('dfs.contracts')||'[]'); }
        catch(e){ return []; }
      }
      function renderContractsSummary(){
        var cid = getCurrentCustomerId();
        var btnCreate = document.getElementById('btn-create-contract');
        if(btnCreate){
          if(cid){ btnCreate.dataset.cid = cid; btnCreate.href = '../contracts/index.html?customerId='+encodeURIComponent(cid); }
          else { btnCreate.dataset.cid=''; btnCreate.href='../contracts/index.html'; }
        }
        var tbody = document.querySelector('#contracts-by-customer tbody');
        var sumEl = document.getElementById('contracts-sum');
        if(!tbody||!sumEl) return;

        tbody.innerHTML = '';
        var list = readContracts();
        var rows = cid ? list.filter(x=> String(x.customerId||'')===String(cid)) : [];

        var total = 0;
        rows.forEach(function(r){
          var tr = document.createElement('tr');
          var risksArr = Array.isArray(r.sparten)? r.sparten : (Array.isArray(r.risks)? r.risks : []);
          var risks = Array.isArray(risksArr) ? risksArr.join(', ') : (r.risks||'');
          var pay = r.zahlweise||r.paymentFrequency||r.payCycle||r.pay||'';
          var premium = Number(r.jahresbeitragBrutto||r.annualPremium||r.annual||r.premiumYear||r.premium||0) || 0;
          total += premium;

          tr.innerHTML = [
            `<td>${r.versicherer||r.insurer||''}</td>`,
            `<td>${r.policeNr||r.policyNumber||r.policyNo||r.policy||''}</td>`,
            `<td>${risks}</td>`,
            `<td>${pay}</td>`,
            `<td style="text-align:right">${fmtMoney(premium)}</td>`,
            `<td><a class="btn btn-small" href="../contracts/index.html?customerId=${encodeURIComponent(cid||'')}">Öffnen</a></td>`
          ].join('');
          tbody.appendChild(tr);
        });

        sumEl.textContent = fmtMoney(total);
      }
      document.addEventListener('DOMContentLoaded', renderContractsSummary);
      window.__dfsCustomersRenderContractsSummary = renderContractsSummary;
    })();
  </script>
</body>
</html>
