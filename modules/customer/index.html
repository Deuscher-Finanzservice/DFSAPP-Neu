<!doctype html>
<html lang="de"><head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kundenstammdaten</title>
  <link rel="stylesheet" href="../../styles/base.css">
</head>
<body>
  <div class="card">
    <h2>Kundenstammdaten</h2>
    <p class="label">Eingaben werden lokal gespeichert (localStorage) und können optional in die Cloud synchronisiert werden.</p>
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">
      <div><label class="label">Firma</label><input class="input" id="firma" placeholder="Firmenname"></div>
      <div><label class="label">Ansprechperson</label><input class="input" id="ansprech" placeholder="Name"></div>
      <div><label class="label">E‑Mail (optional)</label><input class="input" id="email" placeholder="name@firma.de"></div>
      <div><label class="label">Telefon</label><input class="input" id="telefon" placeholder="+49 …"></div>
      <div><label class="label">Branche (optional)</label><input class="input" id="branche"></div>
      <div><label class="label">Mitarbeiter (optional)</label><input class="input" id="mitarbeiter" type="number"></div>
      <div><label class="label">Umsatz (optional)</label><input class="input" id="umsatz" type="number" step="0.01"></div>
      <div><label class="label">Gründung (Jahr, optional)</label><input class="input" id="gruendung" type="number"></div>
      <div><label class="label">Standort (optional)</label><input class="input" id="standort"></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="save">Speichern</button>
      <button class="btn outline" id="clear">Leeren</button>
      <a class="btn outline" href="../customers/index.html">Zur Kundenliste</a>
    </div>
  </div>
  <script type="module">
    import { saveCustomerToCloud } from '../../scripts/firebase.js';
    const KEY='dfs.customers';
    const $=id=>document.getElementById(id);
    const params = new URLSearchParams(location.search);
    let currentId = params.get('id') || (crypto.randomUUID? crypto.randomUUID(): `${Date.now()}-${Math.random().toString(36).slice(2)}`);

    function getLocal(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch{ return []; } }
    function setLocal(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
    function loadForm(data={}){
      ['firma','ansprech','email','telefon','branche','mitarbeiter','umsatz','gruendung','standort'].forEach(k=>{ const el=$(k); if(el) el.value = data[k]??''; });
    }
    // If id provided, load that customer
    (function init(){
      const list = getLocal();
      const existing = list.find(c=>c.id===currentId);
      if(existing) loadForm(existing);
    })();

    document.getElementById('save').onclick = async ()=>{
      const data = {
        id: currentId,
        firma: $('firma').value,
        ansprech: $('ansprech').value,
        email: $('email').value,
        telefon: $('telefon').value,
        branche: $('branche').value||undefined,
        mitarbeiter: Number($('mitarbeiter').value)||undefined,
        umsatz: Number($('umsatz').value)||undefined,
        gruendung: Number($('gruendung').value)||undefined,
        standort: $('standort').value||undefined,
        updatedAt: new Date().toISOString(),
        createdAt: new Date().toISOString()
      };
      const list = getLocal();
      const idx = list.findIndex(c=>c.id===currentId);
      if(idx>=0) list[idx] = { ...list[idx], ...data };
      else list.push(data);
      setLocal(list);
      try{ await saveCustomerToCloud(data); }catch(e){ console.warn('Cloud save failed', e); }
      alert('Kunde gespeichert');
    };

    document.getElementById('clear').onclick = ()=>{ loadForm({}); };
  </script>
</body>
</html>
