<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kunde bearbeiten</title>
  <link rel="stylesheet" href="../../styles/base.css">
  <style>
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    pre.preview{white-space:pre-wrap;background:rgba(255,255,255,.06);border:1px solid var(--card-bd);border-radius:12px;padding:12px;max-height:240px;overflow:auto}
  </style>
  <script>
    // no module needed for simple qs helper
    window._qs = new URLSearchParams(location.search);
  </script>
</head>
<body>
  <div class="card">
    <h2>Kundenstammdaten</h2>
    <div class="grid">
      <div><label class="label">Firma</label><input class="input" id="firma"></div>
      <div><label class="label">Ansprechpartner</label><input class="input" id="ansprech"></div>
      <div><label class="label">E‑Mail</label><input class="input" id="email" type="email"></div>
      <div><label class="label">Telefon</label><input class="input" id="telefon"></div>
      <div><label class="label">Branche (optional)</label><input class="input" id="branche"></div>
      <div><label class="label">Mitarbeiter (optional)</label><input class="input" id="mitarbeiter" type="number" step="1" min="0"></div>
      <div><label class="label">Umsatz in € (optional)</label><input class="input" id="umsatz" type="number" step="0.01" min="0"></div>
      <div><label class="label">Gründungsjahr (optional)</label><input class="input" id="gruendung" type="number" step="1" min="0"></div>
      <div style="grid-column:1/-1"><label class="label">Standort (optional)</label><input class="input" id="standort"></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
      <button class="btn" id="save">Speichern</button>
      <button class="btn outline" id="delete" style="display:none">Löschen</button>
      <a class="btn outline" href="../customers/index.html">Zur Liste</a>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="label">Key im Browser: dfs.customers</div>
      <pre id="preview" class="preview">[]</pre>
    </div>
  </div>
  <script type="module">
    import { saveCustomerToCloud, deleteCustomerFromCloud } from '../../scripts/firebase.js';
    const KEY='dfs.customers';
    const $=id=>document.getElementById(id);
    function getLocal(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch{ return []; } }
    function setLocal(a){ localStorage.setItem(KEY, JSON.stringify(a)); }
    function renderPreview(){ const arr=getLocal(); $('preview').textContent = JSON.stringify(arr, null, 2); }
    function fill(c){ if(!c) return; ['firma','ansprech','email','telefon','branche','mitarbeiter','umsatz','gruendung','standort'].forEach(k=>{ const el=$(k); if(!el) return; const v=c[k]; el.value = (v===undefined||v===null)? '' : String(v); }); }
    const genId = () => (crypto && typeof crypto.randomUUID==='function') ? crypto.randomUUID() : `${Date.now()}-${Math.random().toString(36).slice(2)}`;
    let id = window._qs.get('id') || null;
    if(!id){ id = genId(); }
    let list = getLocal();
    let current = window._qs.get('id') ? list.find(x=>x.id===id) : null;
    if(current){ $('delete').style.display='inline-block'; }
    fill(current);
    function toNum(v){ const n = Number(v); return Number.isFinite(n) ? n : undefined; }
    function collect(){
      return {
        id,
        firma: $('firma').value.trim(),
        ansprech: $('ansprech').value.trim(),
        email: $('email').value.trim(),
        telefon: $('telefon').value.trim(),
        branche: $('branche').value.trim() || undefined,
        mitarbeiter: toNum($('mitarbeiter').value),
        umsatz: toNum($('umsatz').value),
        gruendung: toNum($('gruendung').value),
        standort: $('standort').value.trim() || undefined,
        updatedAt: new Date().toISOString(),
        createdAt: current?.createdAt || new Date().toISOString()
      };
    }
    document.getElementById('save').onclick = async ()=>{
      const c = collect();
      const arr = getLocal();
      const idx = arr.findIndex(x=>x.id===c.id);
      if(idx>=0) arr[idx]=c; else arr.push(c);
      setLocal(arr);
      try{ await saveCustomerToCloud(c); }catch(e){ console.warn('Cloud save failed', e); }
      if(!window._qs.get('id')){ history.replaceState({},'',`?id=${encodeURIComponent(id)}`); $('delete').style.display='inline-block'; }
      renderPreview();
      alert('Gespeichert');
    };
    document.getElementById('delete').onclick = async ()=>{
      if(!id) return;
      if(!confirm('Diesen Kunden löschen?')) return;
      const next = getLocal().filter(x=>x.id!==id);
      setLocal(next);
      try{ await deleteCustomerFromCloud(id); }catch(e){ console.warn('Cloud delete failed', e); }
      location.href = '../customers/index.html';
    };
    renderPreview();
  </script>
</body>
</html>
