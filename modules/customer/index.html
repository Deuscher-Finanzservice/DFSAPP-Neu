<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kunde bearbeiten</title>
  <link rel="stylesheet" href="../../styles/base.css">
  <link rel="stylesheet" href="../../styles/print.css" media="print">
  <script src="../../scripts/format.js"></script>
  <script src="../../scripts/toast.js"></script>
  <script src="../../scripts/ui.js"></script>
  <script src="../../scripts/nav.js"></script>
  <script src="../../scripts/date.js"></script>
  <script src="../../scripts/storage.js"></script>
  <script type="module" src="../../scripts/firebase.js"></script>
  <script src="../../scripts/dfs-cloud.js"></script>
  <script type="module" src="../../scripts/data-contracts.js"></script>
  <script src="../../scripts/save-status.js"></script>
  <style>
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
  </style>
  <script>
    // no module needed for simple qs helper
    window._qs = new URLSearchParams(location.search);
  </script>
</head>
<body>
  <div class="card">
    <h2>Kundenstammdaten</h2>
    <div class="actions-top no-print">
      <button class="btn-ghost" onclick="dfsNav.backOr('../customers/index.html')">← Zur Kundenliste</button>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="btn-save-customer" class="btn">Speichern</button>
        <span id="save-status-customer" class="pill text-secondary">Ungespeichert</span>
        <span id="save-meta-customer" class="save-meta">—</span>
        <button id="save-retry" class="btn-ghost sm no-print" style="display:none">Erneut senden</button>
      </div>
    </div>
    <header class="print-header no-screen" id="print-header"></header>
    <div class="actions no-print" style="display:flex; gap:8px; justify-content:flex-end; margin-bottom:8px;">
      <button class="btn btn-primary" onclick="window.print()">Als PDF speichern</button>
    </div>
    <div class="grid">
      <div><label class="label">Firma</label><input class="input" id="firma"></div>
      <div><label class="label">Ansprechpartner</label><input class="input" id="ansprech"></div>
      <div><label class="label">E‑Mail</label><input class="input" id="email" type="email"></div>
      <div><label class="label">Telefon</label><input class="input" id="telefon"></div>
      <div>
        <label class="label" for="cust-branche">Branche (optional)</label>
        <select class="input" id="cust-branche">
          <option value="">– bitte wählen –</option>
          <option>Baugewerbe allgemein</option>
          <option>Dachdecker</option>
          <option>Maler / Lackierer</option>
          <option>Elektroinstallateur</option>
          <option>Sanitär / Heizung / Klima</option>
          <option>Tischler / Schreiner</option>
          <option>Metallbauer</option>
          <option>Maurer / Betonbauer</option>
          <option>Garten- & Landschaftsbau</option>
          <option>Kfz-Werkstatt / Kfz-Service</option>
          <option>Friseur / Kosmetik</option>
          <option>Bäckerei / Konditorei</option>
          <option>Gastronomie / Restaurant / Café</option>
          <option>Hotel / Pension</option>
          <option>Einzelhandel allgemein</option>
          <option>Lebensmittelhandel</option>
          <option>Großhandel</option>
          <option>IT / Software / Systemhaus</option>
          <option>Marketing / Werbung / Agentur</option>
          <option>Architekt / Ingenieurbüro</option>
          <option>Rechtsanwalt / Notar</option>
          <option>Steuerberater / Wirtschaftsprüfer</option>
          <option>Arztpraxis</option>
          <option>Pflege / Pflegedienst</option>
          <option>Spedition / Transport</option>
          <option>Logistik / Lager</option>
          <option>Landwirtschaft</option>
          <option>Immobilien / Hausverwaltung</option>
          <option>Energie / erneuerbare Energien</option>
          <option>Sonstige Dienstleistungen</option>
        </select>
      </div>
      <div><label class="label">Mitarbeiter (optional)</label><input class="input" id="mitarbeiter" type="number" step="1" min="0"></div>
      <div><label class="label">Umsatz in € (optional)</label><input class="input" id="umsatz" type="number" step="0.01" min="0"></div>
      <div><label class="label">Gründungsjahr (optional)</label><input class="input" id="gruendung" type="number" step="1" min="0"></div>
      <div style="grid-column:1/-1">
        <label class="label">Adresse (Straße + Nr.)</label>
        <input class="input" id="cust-addr-adresse" placeholder="z. B. Musterstraße 12">
      </div>
      <div>
        <label class="label">PLZ</label>
        <input class="input" id="cust-addr-plz" maxlength="10" placeholder="z. B. 22111">
      </div>
      <div>
        <label class="label">Ort</label>
        <input class="input" id="cust-addr-ort" placeholder="z. B. Hamburg">
      </div>
    </div>
    <section class="card" style="margin-top:16px;">
      <h3>Erweiterte Daten</h3>
      <div class="accordion" id="cust-accordion">
        <div class="acc-item" id="acc-bank">
          <div class="acc-head"><strong>Bankverbindung</strong><span>▸</span></div>
          <div class="acc-body">
            <div class="grid">
              <div><label class="label">IBAN</label><input id="cust-bank-iban" class="input" type="text" placeholder="DE.."></div>
              <div><label class="label">BIC</label><input id="cust-bank-bic" class="input" type="text" placeholder="GENODE.."></div>
              <div><label class="label">Bankname</label><input id="cust-bank-name" class="input" type="text" placeholder="Bank"></div>
            </div>
          </div>
        </div>
        <div class="acc-item" id="acc-tax">
          <div class="acc-head"><strong>Steuerinformationen</strong><span>▸</span></div>
          <div class="acc-body">
            <div class="grid">
              <div><label class="label">Steuernummer</label><input id="cust-tax-steuernr" class="input" type="text"></div>
              <div><label class="label">USt-ID</label><input id="cust-tax-ustid" class="input" type="text"></div>
            </div>
          </div>
        </div>
        <div class="acc-item" id="acc-risk">
          <div class="acc-head"><strong>Weitere Standorte / Risiko-Adressen</strong><span>▸</span></div>
          <div class="acc-body">
            <div id="risk-list"></div>
            <button class="btn" id="risk-add" style="margin-top:8px">+ Standort hinzufügen</button>
          </div>
        </div>
        <div class="acc-item" id="acc-docs">
          <div class="acc-head"><strong>Dokumente</strong><span>▸</span></div>
          <div class="acc-body">
            <div class="docs-list" id="cust-docs"></div>
            <div style="margin-top:8px;">
              <label class="btn btn-secondary">Datei hochladen
                <input id="cust-file-input" type="file" accept=".pdf,.png,.jpg,.jpeg" style="display:none">
              </label>
            </div>
            <small class="text-secondary">PDF/JPG/PNG. Dateien werden in die Cloud (Firebase Storage) hochgeladen.</small>
          </div>
        </div>
      </div>
    </section>
    <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
      <button class="btn" id="save">Speichern</button>
      <button class="btn outline" id="delete" style="display:none">Löschen</button>
      <a class="btn outline" href="../customers/index.html">Zur Liste</a>
      <a class="btn outline" id="btn-dashboard" href="#">Kunden-Dashboard</a>
    </div>
    <div class="card" id="customer-contracts-card" style="margin-top:16px">
      <h3>Verträge dieses Kunden</h3>
      <div style="display:flex;gap:8px;margin-bottom:8px;">
        <a id="btn-create-contract" class="btn" href="#" data-cid="">Vertrag anlegen</a>
      </div>
      <div class="table-wrapper">
        <table class="table" id="contracts-by-customer">
          <thead>
            <tr>
              <th>Versicherer</th>
              <th>Police</th>
              <th>Risiken</th>
              <th>Zahlweise</th>
              <th>Beitrag (€/J)</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody><!-- dynamic --></tbody>
          <tfoot>
            <tr>
              <td colspan="4" style="text-align:right"><strong>Summe</strong></td>
              <td id="contracts-sum" style="text-align:right">0,00 €</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    <div class="card intern-only" style="margin-top:16px">
      <h3>Interner Vermerk (nur intern)</h3>
      <div id="customer-intern-vermerk"></div>
    </div>
    <footer class="print-footer no-screen" id="print-footer"></footer>
  </div>
  <script type="module">
    import { saveCustomerToCloud, deleteCustomerFromCloud } from '../../scripts/firebase.js';
    const KEY='dfs.customers';
    const $=id=>document.getElementById(id);
    function getLocal(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch{ return []; } }
    function setLocal(a){ localStorage.setItem(KEY, JSON.stringify(a)); }
    function fill(c){
      if(!c) return;
      ['firma','ansprech','email','telefon','mitarbeiter','umsatz','gruendung'].forEach(k=>{ const el=$(k); if(!el) return; const v=c[k]; el.value = (v===undefined||v===null)? '' : String(v); });
      const sb=document.getElementById('cust-branche'); if(sb) sb.value = c?.branche || '';
      const addr = c?.standort || {};
      const a=document.getElementById('cust-addr-adresse'); if(a) a.value = addr.adresse||'';
      const p=document.getElementById('cust-addr-plz'); if(p) p.value = addr.plz||'';
      const o=document.getElementById('cust-addr-ort'); if(o) o.value = addr.ort||'';
    }
    const genId = () => (crypto && typeof crypto.randomUUID==='function') ? crypto.randomUUID() : `${Date.now()}-${Math.random().toString(36).slice(2)}`;
    let id = window._qs.get('id') || null;
    if(!id){ id = genId(); }
    let list = getLocal();
    let current = window._qs.get('id') ? list.find(x=>x.id===id) : null;
    if(current){ $('delete').style.display='inline-block'; }
    fill(current);
    function toNum(v){ const n = Number(v); return Number.isFinite(n) ? n : undefined; }
    function collect(){
      return {
        id,
        firma: $('firma').value.trim(),
        ansprech: $('ansprech').value.trim(),
        email: $('email').value.trim(),
        telefon: $('telefon').value.trim(),
        branche: (document.getElementById('cust-branche')?.value || '').trim() || undefined,
        mitarbeiter: toNum($('mitarbeiter').value),
        umsatz: toNum($('umsatz').value),
        gruendung: toNum($('gruendung').value),
        standort: {
          adresse: (document.getElementById('cust-addr-adresse')?.value||'').trim(),
          plz: (document.getElementById('cust-addr-plz')?.value||'').trim().slice(0,10),
          ort: (document.getElementById('cust-addr-ort')?.value||'').trim()
        },
        updatedAt: new Date().toISOString(),
        createdAt: current?.createdAt || new Date().toISOString()
      };
    }
    function validateCustomerEmailOptional(){
      const el = document.getElementById('email');
      if(!el) return true; const v=(el.value||'').trim(); if(v==='') return true;
      const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
      if(!ok){ try{ dfsToast('E-Mail-Format prüfen (optional, aber wenn gefüllt, dann gültig).','error'); }catch{} }
      return ok;
    }
    document.getElementById('save').onclick = async ()=>{
      if(!validateCustomerEmailOptional()) return;
      const c = collect();
      const arr = getLocal();
      const idx = arr.findIndex(x=>x.id===c.id);
      if(idx>=0) arr[idx]=c; else arr.push(c);
      setLocal(arr);
      try{ await saveCustomerToCloud(c); }catch(e){ console.warn('Cloud save failed', e); }
      if(!window._qs.get('id')){ history.replaceState({},'',`?id=${encodeURIComponent(id)}`); $('delete').style.display='inline-block'; }
      if(window.__dfsCustomersRenderContractsSummary) window.__dfsCustomersRenderContractsSummary();
      try{ dfsToast('Kunde gespeichert.','success'); }catch{}
    };
    document.getElementById('delete').onclick = async ()=>{
      if(!id) return;
      dfsUI.show({
        title:'Kunden löschen',
        text:'Der Kunde und seine Dokumente werden entfernt. Optional können verknüpfte Verträge ebenfalls gelöscht werden.',
        checkText:'Ja, ich will diesen Kunden endgültig löschen.',
        onOk: async ()=>{
          try{
            const filesMap = dfsStore.get('dfs.customerFiles', {});
            const files = filesMap[id] || [];
            for(const f of files){ try{ await dfsFiles.removeByPath(f.id); }catch(_){} }
            delete filesMap[id]; dfsStore.set('dfs.customerFiles', filesMap);
            const next = getLocal().filter(x=>x.id!==id); setLocal(next);
            try{ await deleteCustomerFromCloud(id); }catch(e){ console.warn('Cloud delete failed', e); }
            if(confirm('Auch verknüpfte Verträge dieses Kunden löschen?')){
              let contracts = dfsStore.get('dfs.contracts', []);
              const cfilesMap = dfsStore.get('dfs.contractFiles', {});
              const toDelete = contracts.filter(v=> String(v.customerId||'')===String(id)).map(v=>v.id);
              for(const cid of toDelete){
                for(const f of (cfilesMap[cid]||[])){ try{ await dfsFiles.removeByPath(f.id); }catch(_){} }
                delete cfilesMap[cid]; try{ await dfsCloud.delete('dfs.contracts', cid); }catch{}
              }
              dfsStore.set('dfs.contractFiles', cfilesMap);
              contracts = contracts.filter(v=> String(v.customerId||'')!==String(id));
              dfsStore.set('dfs.contracts', contracts);
            }
            location.href = '../customers/index.html';
          }catch(e){ console.error(e); dfsToast('Löschen fehlgeschlagen','error'); }
        }
      });
    };
    (function(){
      function fmtMoney(n){
        try{ return (Number(n)||0).toLocaleString('de-DE',{style:'currency',currency:'EUR',minimumFractionDigits:2}); }
        catch(e){ return (Number(n)||0).toFixed(2)+' €'; }
      }
      function getCurrentCustomerId(){
        var hid = document.getElementById('id');
        if(hid && hid.value) return hid.value;
        var p=new URLSearchParams(location.search);
        if(p.get('id')) return p.get('id');
        try{
          var name = (document.querySelector('input[id="firma"]')||{}).value||'';
          var email = (document.querySelector('input[id="email"]')||{}).value||'';
          var arr = JSON.parse(localStorage.getItem('dfs.customers')||'[]');
          var hit = arr.find(c=> (c.firma||'')===name && (c.email||'')===email );
          return hit ? hit.id : null;
        }catch(e){}
        return null;
      }
      async function renderContractsSummary(){
        var cid = getCurrentCustomerId();
        var btnCreate = document.getElementById('btn-create-contract');
        if(btnCreate){
          if(cid){ btnCreate.dataset.cid = cid; btnCreate.href = '../contracts/index.html?customerId='+encodeURIComponent(cid); }
          else { btnCreate.dataset.cid=''; btnCreate.href='../contracts/index.html'; }
        }
        var tbody = document.querySelector('#contracts-by-customer tbody');
        var sumEl = document.getElementById('contracts-sum');
        if(!tbody||!sumEl) return;

        tbody.innerHTML = '';
        var rows = [];
        if(cid){
          try{
            if(window.dfsDataContracts && dfsDataContracts.loadContractsByCustomer){
              rows = await dfsDataContracts.loadContractsByCustomer(cid);
            }else if(window.dfsData && dfsData.getAllContracts){
              const all = await dfsData.getAllContracts();
              rows = (all||[]).filter(x=> String(x.customerId||'')===String(cid));
            }
          }catch(e){ rows = []; }
        }

        var total = 0;
        rows.forEach(function(r){
          var tr = document.createElement('tr');
          var risksArr = Array.isArray(r.sparten)? r.sparten : (Array.isArray(r.risks)? r.risks : []);
          var risks = Array.isArray(risksArr) ? risksArr.join(', ') : (r.risks||'');
          var pay = r.zahlweise||r.paymentFrequency||r.payCycle||r.pay||'';
          var premium = Number(r.jahresbeitragBrutto||r.annualPremium||r.annual||r.premiumYear||r.premium||0) || 0;
          total += premium;

          tr.innerHTML = [
            `<td>${r.versicherer||r.insurer||'—'}</td>`,
            `<td>${r.policeNr||r.policyNumber||r.policyNo||r.policy||'—'}</td>`,
            `<td>${risks}</td>`,
            `<td>${pay||'—'}</td>`,
            `<td style="text-align:right">${fmtMoney(premium)}</td>`,
            `<td><a class="btn btn-small" href="../contracts/index.html?customerId=${encodeURIComponent(cid||'')}">Öffnen</a></td>`
          ].join('');
          tbody.appendChild(tr);
        });

        sumEl.textContent = fmtMoney(total);
      }
      document.addEventListener('DOMContentLoaded', renderContractsSummary);
      window.__dfsCustomersRenderContractsSummary = renderContractsSummary;
    })();
    // Link zum Kunden-Dashboard
    document.addEventListener('DOMContentLoaded', ()=>{ const a=document.getElementById('btn-dashboard'); if(a){ a.href = `../customers/dashboard.html?id=${encodeURIComponent(id)}`; } });
    // Auto-Save (Kunde)
    let __autoSaveTimerCustomer = null;
    function doSaveCustomer(){
      const c = collect();
      let arr = (window.dfsStore&&dfsStore.get)? dfsStore.get(KEY,[]) : getLocal();
      const idx = arr.findIndex(x=>x.id===c.id);
      if(idx>=0) arr[idx] = {...arr[idx], ...c, updatedAt:new Date().toISOString()}; else arr.push({...c, createdAt:new Date().toISOString(), updatedAt:new Date().toISOString()});
      if(window.dfsStore&&dfsStore.set) dfsStore.set(KEY, arr); else setLocal(arr);
      try{ dfsToast('Kunde gespeichert','success'); }catch{}
    }
    function handleAutoSaveCustomer(){
      const cfg = (window.dfsStore&&dfsStore.get)? dfsStore.get('dfs.config.save',{autoSaveMode:'immediate',autoSaveInterval:10,cloudSync:true}) : {autoSaveMode:'immediate',autoSaveInterval:10,cloudSync:true};
      if(cfg.autoSaveMode==='manual') return;
      if(cfg.autoSaveMode==='immediate'){
        doSaveCustomer();
      }else if(cfg.autoSaveMode==='interval'){
        if(__autoSaveTimerCustomer) clearTimeout(__autoSaveTimerCustomer);
        __autoSaveTimerCustomer = setTimeout(doSaveCustomer, Math.max(5, Number(cfg.autoSaveInterval||10))*1000);
      }
    }
    function autoBindCustomerForm(){
      const ids=['firma','ansprech','email','telefon','cust-branche','mitarbeiter','umsatz','gruendung','cust-addr-adresse','cust-addr-plz','cust-addr-ort'];
      ids.forEach(k=>{ const el=document.getElementById(k); if(!el) return; const evt = (el.tagName==='SELECT')?'change':'input'; el.addEventListener(evt, handleAutoSaveCustomer); });
    }
    // Migration: wenn standort Freitext war → in standortLegacy sichern und struktur anlegen
    document.addEventListener('DOMContentLoaded', ()=>{
      try{
        const arr = dfsStore.get('dfs.customers', []);
        const idx = arr.findIndex(x=>x.id===id);
        if(idx>=0 && typeof arr[idx].standort === 'string' && arr[idx].standort){
          arr[idx].standortLegacy = arr[idx].standort;
          arr[idx].standort = { adresse:'', plz:'', ort:'' };
          dfsStore.set('dfs.customers', arr);
        }
      }catch{}
    });
    document.addEventListener('DOMContentLoaded', autoBindCustomerForm);
    // Initialer Cloud→Local Sync
    document.addEventListener('DOMContentLoaded', async ()=>{ try{ if(window.dfsStore&&dfsStore.syncFromCloud){ await dfsStore.syncFromCloud('dfs.customers'); } }catch{} });
    // Print header/footer from config
    document.addEventListener('DOMContentLoaded', ()=>{
      try{
        const cfg = (window.dfsStore && dfsStore.get) ? dfsStore.get('dfs.config.print', null) : JSON.parse(localStorage.getItem('dfs.config.print')||'null');
        const head = document.getElementById('print-header');
        const foot = document.getElementById('print-footer');
        if(cfg){
          if(head){ head.innerHTML=''; (cfg.logos||[]).forEach(url=>{ const img=document.createElement('img'); img.src=url; img.style.height='28px'; img.style.marginRight='8px'; head.appendChild(img); }); const h=document.createElement('h1'); h.textContent = cfg.headerText||'DFS Versicherungsanalyse'; head.appendChild(h); }
          if(foot){ const version = localStorage.getItem('dfs.version')||'unversioniert'; const now=new Date(); const p=n=>String(n).padStart(2,'0'); const ts=`${p(now.getDate())}.${p(now.getMonth()+1)}.${now.getFullYear()}`; foot.textContent = `${cfg.footerText||''} – Version ${version}, gedruckt am ${ts}`; }
        }
      }catch{}
    });
  </script>
  <script src="./detail-extended.js"></script>
</body>
</html>
